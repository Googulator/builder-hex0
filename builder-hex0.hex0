# Builder-Hex0
#
# Builder-Hex0 is a small bootable machine image which has
# the ability to compile hex0 code. It is also written in hex0
# and so it can build itself if provided with its own source code.
#
# hex0 is a "language" for binary encoding in hexadecimal
# with support for comments.
#
# This file was hand assembled using this reference:
# http://www.mathemainzel.info/files/x86asmref.html
#
# boot drive is in dl
#
#[7C00]
#:_start

# This is extra safe code to ensure the registers
# are initialized. A long jump sets CS to 0000.
EA 05 7C 00 00 # JMP 00007C05  jmp &_init_registers
#:_init_registers
31 C0     # xor ax, ax
# TODO COPY_AX_to_DS   mov ds, ax
# TODO COPY_AX_to_ES   mov es, ax

#[7C00]
#:_load_stage2

# TODO: need to save boot drive (which is in dl)

# read the second sector
BB 00 7E  # LOADI16_BX 7E00  ; destination address for read = ES:BX = 0000:7E00
B8 01 02  # LOADI16_AX 0201  ; rw mode = 02 (read),  num_sectors = 01
B9 02 00  # LOADI16_CX 0002  ; cylinder = 0, sector_num = 02
B6 00     # LOADI8_DH 00     ; head = 0
CD 13     # INT_13

# change the second sector
B0 4F     # LOADI8_AL 'O'
A2 00 7E  # mov [7E00], AL

# write the second sector
BB 00 7E  # LOADI16_BX 7E00  ; source address for write = ES:BX = 0000:7E00
B8 01 03  # LOADI16_AX 0201  ; rw mode = 03 (write),  num_sectors = 01
B9 02 00  # LOADI16_CX 0002  ; cylinder = 0, sector_num = 02
B6 00     # LOADI8_DH 00     ; head = 0
CD 13     # INT_13


#:_kern_print_ok

# Prepare to use BIOS tty output interrupt.

# Specify text page 00, 0 black background, 7 light grey text
BB 00 07  # LOADI16_BX 0007
# Specify write character
B4 0E     # LOADI8_AH  0E

# puts("OK\r\n.\r\n")

B0 4F     # LOADI8_AL 'O'
CD 10     # INT_10

B0 4B     # LOADI8_AL 'K'
CD 10     # INT_10

B0 0D     # LOADI8_AL '\r'
CD 10     # INT_10

B0 0A     # LOADI8_AL '\n'
CD 10     # INT_10


B0 2E     # LOADI8_AL '.'
CD 10     # INT_10

B0 0D     # LOADI8_AL '\r'
CD 10     # INT_10

B0 0A     # LOADI8_AL '\n'
CD 10     # INT_10

# :reboot
# :syscall_reboot
EA F0 FF 00 F0  # ljmp $F000:FFF0
# End of Program.

#[7C40]
                                    00 00 00 00
#[7C50]
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
#[7C60]
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
#[7C70]
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00

#[7C80]
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
#[7CC0]
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
#[7D00]
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
#[7D40]
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
#[7D80]
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00

#[7DB0]
00 00 00 00 00 00 00 00 00 00 00 00 00 00

# Partition entry 1
#[7DBE]
                                          00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 
# Partition entry 2
#[7DD0]
                                          00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 
# Partition entry 3
                                          00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 
# Partition entry 4
                                          00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 
#[7DFE]
# This is the DOS/MBR identifier at offset 510:
55 AA 


# This is the second 512 byte block which holds the stage 2 loader.
#[7E00]
#H W  (Hello World)
48 57 00 00 00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
#[7E40]
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
#[7E80]
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
#[7EC0]
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
#[7F00]
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
#[7F40]
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
#[7F80]
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
#[7FC0]
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
